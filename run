#!/usr/bin/env bash
#
# usage: ./run command [argument ...]
#
# Commands for managing the halos-distro workspace.
#
# See https://death.andgravity.com/run-sh
# for an explanation of how it works and why it's useful.

# First, set up the environment.
# (Check the notes at the end when changing this.)

set -o nounset
set -o pipefail
set -o errexit

# Enable this to echo commands as they are executed.
#set -o xtrace

# Change the current directory to the project root.
PROJECT_ROOT=${0%/*}
if [[ $0 != $PROJECT_ROOT && $PROJECT_ROOT != "" ]]; then
  cd "$PROJECT_ROOT"
fi
readonly PROJECT_ROOT=$(pwd)

# Store the absolute path to this script (useful for recursion).
readonly SCRIPT="$PROJECT_ROOT/$(basename "$0")"

################################################################################
# Repository Definitions

declare -A REPOS=(
  ["halos-pi-gen"]="git@github.com:hatlabs/halos-pi-gen.git main"
  ["apt.hatlabs.fi"]="git@github.com:hatlabs/apt.hatlabs.fi.git main"
  ["runtipi-marine-app-store"]="git@github.com:hatlabs/runtipi-marine-app-store.git main"
  ["runtipi-docker-service"]="git@github.com:hatlabs/runtipi-docker-service.git main"
  ["avnav-docker"]="git@github.com:hatlabs/avnav-docker.git main"
  ["opencpn-docker"]="git@github.com:hatlabs/opencpn-docker.git main"
  ["cockpit-apt"]="git@github.com:hatlabs/cockpit-apt.git main"
  ["cockpit-branding-halos"]="git@github.com:hatlabs/cockpit-branding-halos.git main"
  ["cockpit-networkmanager-halos"]="git@github.com:hatlabs/cockpit-networkmanager-halos.git main"
  ["halos-metapackages"]="git@github.com:hatlabs/halos-metapackages.git main"
  ["halos-core-containers"]="git@github.com:hatlabs/halos-core-containers.git main"
)

################################################################################
# Repository Management Commands

function clone-repos {
  #@ Clone any missing repositories
  #@ Category: Repository Management
  echo "üîÑ Checking repositories..."

  local cloned=0
  local skipped=0

  for repo in "${!REPOS[@]}"; do
    if [ -d "$repo" ]; then
      echo "‚è≠Ô∏è  $repo (already exists)"
      ((skipped++))
    else
      read -r url branch <<< "${REPOS[$repo]}"
      echo "üì• Cloning $repo (branch: $branch)..."
      if git clone -b "$branch" "$url" "$repo"; then
        echo "‚úÖ $repo cloned successfully"
        ((cloned++))
      else
        echo "‚ùå Failed to clone $repo"
        return 1
      fi
    fi
  done

  echo ""
  echo "üìä Summary: $cloned cloned, $skipped skipped"
}

function pull-all-main {
  #@ Pull latest changes from main branches for all repos
  #@ Category: Repository Management
  echo "üîÑ Updating all repositories..."

  local updated=0
  local failed=0
  local missing=0

  for repo in "${!REPOS[@]}"; do
    if [ ! -d "$repo" ]; then
      echo "‚ö†Ô∏è  $repo (missing - run 'clone-repos' first)"
      ((missing++))
      continue
    fi

    read -r url branch <<< "${REPOS[$repo]}"
    echo "üì• Updating $repo (branch: $branch)..."

    if (cd "$repo" && git pull origin "$branch"); then
      echo "‚úÖ $repo updated successfully"
      ((updated++))
    else
      echo "‚ùå Failed to update $repo"
      ((failed++))
    fi
  done

  echo ""
  echo "üìä Summary: $updated updated, $failed failed, $missing missing"

  if [ $failed -gt 0 ]; then
    return 1
  fi
}

function show-status {
  #@ Show git status for all repositories
  #@ Category: Repository Management
  echo "üìä Repository status:"
  echo ""

  for repo in "${!REPOS[@]}"; do
    if [ ! -d "$repo" ]; then
      echo "‚ùå $repo: NOT CLONED"
      continue
    fi

    echo "üìÅ $repo:"
    (cd "$repo" && git status -sb)
    echo ""
  done
}

################################################################################
# Setup Commands

function install-hooks {
  #@ Install pre-commit hooks using lefthook
  #@ Category: Setup
  if ! command -v lefthook &> /dev/null; then
    echo "‚ùå lefthook not found. Install it first:"
    echo "   brew install lefthook"
    return 1
  fi

  echo "üîß Installing pre-commit hooks..."
  lefthook install
  echo "‚úÖ Hooks installed successfully"
}

function run-hooks {
  #@ Run pre-commit hooks manually
  #@ Category: Setup
  if ! command -v lefthook &> /dev/null; then
    echo "‚ùå lefthook not found. Install it first:"
    echo "   brew install lefthook"
    return 1
  fi

  echo "üîç Running pre-commit hooks..."
  lefthook run pre-commit
}

################################################################################
# Help System

function help {
  #@ Show this help message
  #@ Category: Core
  echo "Available commands:"
  echo ""

  # Extract function definitions and their help comments
  awk '/^function / {
    fname = $2
    sub(/[({].*/, "", fname)
    getline
    if ($0 ~ /#@/) {
      desc = $0
      sub(/.*#@ /, "", desc)
      sub(/ *$/, "", desc)
      getline
      if ($0 ~ /#@ Category:/) {
        cat = $0
        sub(/.*Category: /, "", cat)
        sub(/ *$/, "", cat)
        if (!seen[cat]++) categories[++cat_count] = cat
        commands[cat, ++cmd_count[cat]] = fname
        descriptions[cat, cmd_count[cat]] = desc
      }
    }
  }
  END {
    for (i = 1; i <= cat_count; i++) {
      cat = categories[i]
      print "\n" cat ":"
      for (j = 1; j <= cmd_count[cat]; j++) {
        printf "  %-30s %s\n", commands[cat, j], descriptions[cat, j]
      }
    }
  }' "$0"

  echo ""
  echo "Usage: ./run <command> [arguments...]"
}

################################################################################
# Commands end.

# Dispatch to command. A simpler version would be just "$@" (with the quotes!).

TIMEFORMAT=$'\nTask completed in %3lR'
time "${@:-help}"

# Some dev notes for this script.
#
# The commands *require*:
#
# * The current working directory is the project root.
# * The shell options and globals are set as they are.
#
# Inspired by the following:
#  - https://death.andgravity.com/run-sh
#  - http://www.oilshell.org/blog/2020/02/good-parts-sketch.html
#  - https://www.youtube.com/watch?v=SdmYd5hJISM&t=7s
